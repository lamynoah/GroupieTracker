<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetitBac</title>
    <link rel="stylesheet" type="text/css" href="/static/styles/ptitbac.css">
</head>

{{$l := .Letter}}

<body>
    <div id="in-game">
        <h1> Lettre : <span id="letter">{{.Letter}}</span></h1>
        <div id="timer">{{.Time}}s</div>
        <div> Nombre de round : <span id="round">{{ .CurrentRound}}</span> / {{.MaxRound}}</div>
        <form>
            {{range .Categories}}
            <label for="{{.}}">{{.}}:</label>
            <input placeholder="{{$l}}..." type="text" name="{{.}}" id="{{.}}" autocomplete="off" required /><br>
            {{end}}
            <input id="send" type="submit" value="FINISH" />
        </form>
    </div>
    <div id="result" style="display: none;">
        <h1>Resultat</h1>
        {{range .Categories}}
        <h3>{{.}}</h3>
        <ul class="user-result"></ul>
        {{end}}
        {{if .IsCreator}}
        <button onclick="socket.send(JSON.stringify({ Id:getRoomId(), NextRound: true, id_user : Number.parseInt(getCookie('Id')) }))" >Round Suivant</button>
        {{end}}
    </div>
    {{template "socket" "ptitBac"}}
    <script>
        let time = Number.parseInt("{{.Time}}")
        let round = Number.parseInt("{{.CurrentRound}}")

        const timerDiv = document.querySelector("#timer")
        if (time < 1) { // || JSON.parse("{{.IsDone}}")) {
            setFinished()
        }
        const inter = setInterval(() => {
            time--
            timerDiv.textContent = `${time}s`
            if (time === 10) timerDiv.style.color = "red"
            else if (time < 1) clearInterval(inter)
        }, 1000)

        function setFinished() {
            document.querySelector("#in-game").style.display = "none"
            document.querySelector("#result").removeAttribute("style")
        }

        socket.onopen = () => {
            console.log(JSON.stringify({ id_room: getRoomId(), Done: false }))
            socket.send(JSON.stringify({ id_room: getRoomId(), Done: false }))
        }
        socket.onmessage = msg => {
            console.log("recieved :", msg.data)
            let obj = JSON.parse(msg.data)
            // obj = {letter: "L"}
            // "{letter : " + room.Letter + " }"
            // "Timer expired!"
            // "end round"
            // map[username]inputs
            if (obj.letter) {
                const newLetter = document.getElementById("letter")
                newLetter.textContent = obj.letter
                Array.from(document.querySelector("input[type='text']")).forEach(e => {
                    e.placeholder = obj.letter + "..."
                })
                // lettere : 1 dans mon go j 'ai ma lettre 2 , et je veux remplacer ma lettre 1 par la 2 '
            } else if (typeof obj === "object") {
                const divs = document.getElementsByClassName("user-result")
                const map = new Map(Object.entries(obj))
                map.forEach((value, key) => {
                    console.log(`${key}: ${value}`)
                    console.log("type of value =", typeof value)
                    value.forEach((v, i) => {
                        const li = document.createElement("li")
                        li.textContent = `${key}: ${v}`
                        const btnVerif = document.createElement("button")
                        btnVerif.classList.toggle("true")
                        btnVerif.onclick = function () {
                            const category = key;
                            const value = v;
                            if (btnVerif.classList.contains("true")) {
                                btnVerif.classList.toggle("true")
                                btnVerif.classList.toggle("false")
                            } else {
                                btnVerif.classList.toggle("false")
                                btnVerif.classList.toggle("true")
                            }
                        }

                        li.appendChild(btnVerif)
                        divs[i].append(li)
                    })
                })
            }
            switch (obj) {
                case "Timer expired!":
                case "end round":
                    done();
                    setFinished()
                    const arr = Array.from(document.querySelectorAll("input[type='text']")).map(e => e.value)
                    console.log(arr)
                    socket.send(JSON.stringify({ id_room: getRoomId(), Done: false, data: arr, id_user: Number.parseInt(getCookie("Id")) }))
                    break;
            }
        }
        document.querySelector("form").addEventListener("submit", e => {
            e.preventDefault()
            done()
        })
        let done = () => {
            let data = JSON.stringify({ id_room: getRoomId(), Done: true })
            socket.send(data)
            console.log("send :", data)
        }
    </script>
</body>

</html>